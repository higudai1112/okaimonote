<% content_for :title, "ダッシュボード" %>

<section class="space-y-6">
  <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
    <span class="inline-flex items-center justify-center w-8 h-8 rounded-xl bg-orange-100 text-orange-500">
      📊
    </span>
    管理ダッシュボード
  </h1>

  <p class="text-sm text-gray-600">
    okaimonote のデータ状況を確認できます。まずは最低限の画面だけ用意しておき、あとから
    「ユーザー管理」「家族共有管理」「問い合わせ管理」などを順番に追加していきます。
  </p>

  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5">

    <!-- 本日の新規登録者数 -->
    <div class="bg-white rounded-2xl shadow-md border border-orange-100 p-5 flex items-center gap-4">
      <div class="w-12 h-12 flex items-center justify-center rounded-xl bg-orange-100 text-orange-500 text-2xl">
        <i class="fa-solid fa-user-plus"></i>
      </div>

      <div>
        <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">
          本日の新規登録
        </p>

        <div class="flex items-end gap-2">
          <p class="mt-1 text-3xl font-bold text-gray-800">
            <%= @new_users_today %>
          </p>

          <% if @new_users_diff != 0 %>
            <span class="text-sm font-semibold
              <%= @new_users_diff > 0 ? 'text-green-600' : 'text-red-500' %>">
              <%= @new_users_diff > 0 ? '+' : '' %><%= @new_users_diff %>
            </span>
          <% else %>
            <span class="text-sm text-gray-400">±0</span>
          <% end %>
        </div>

        <p class="text-[10px] text-gray-400 mt-1">
          昨日比
        </p>
      </div>
    </div>

    <!-- アクティブユーザー -->
    <div class="bg-white rounded-2xl shadow-md border border-orange-100 p-5 flex items-center gap-4">
      <div class="w-12 h-12 flex items-center justify-center rounded-xl bg-blue-100 text-blue-500 text-2xl">
        <i class="fa-solid fa-bolt"></i>
      </div>
      <div>
        <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">アクティブ（30日）</p>
        <p class="mt-1 text-3xl font-bold text-gray-800"><%= @active_users %></p>
      </div>
    </div>

    <!-- 新規登録（30日） -->
    <div class="bg-white rounded-2xl shadow-md border border-orange-100 p-5 flex items-center gap-4">
      <div class="w-12 h-12 flex items-center justify-center rounded-xl bg-green-100 text-green-500 text-2xl">
        <i class="fa-solid fa-user-plus"></i>
      </div>
      <div>
        <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">
          新規登録（30日）
        </p>
        <div class="flex items-end gap-2">
          <p class="mt-1 text-3xl font-bold text-gray-800">
            <%= @new_users_30d %>
          </p>
          <% if @new_users_30d_diff != 0 %>
            <span class="text-sm font-semibold
              <%= @new_users_30d_diff > 0 ? 'text-green-600' : 'text-red-500' %>">
              <%= @new_users_30d_diff > 0 ? '+' : '' %><%= @new_users_30d_diff %>
            </span>
          <% else %>
            <span class="text-sm text-gray-400">±0</span>
          <% end %>
        </div>
        <p class="text-[10px] text-gray-400 mt-1">
          前30日比
        </p>
      </div>
    </div>

    <!-- ファミリー数 -->
    <div class="bg-white rounded-2xl shadow-md border border-orange-100 p-5 flex items-center gap-4">
      <div class="w-12 h-12 flex items-center justify-center rounded-xl bg-purple-100 text-purple-500 text-2xl">
        <i class="fa-solid fa-people-roof"></i>
      </div>
      <div>
        <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">ファミリー数</p>
        <p class="mt-1 text-3xl font-bold text-gray-800"><%= @total_families %></p>
      </div>
    </div>
  </div>
</section>

<section class="space-y-4 mt-8">
  <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
    <span class="inline-flex items-center justify-center w-8 h-8 rounded-xl bg-red-100 text-red-500">
      ⚠️
    </span>
    アラート
  </h2>

  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">

    <!-- 未対応問い合わせ -->
    <div class="rounded-2xl p-5 shadow-md border
      <%= @unresolved_contacts > 0 ? 'bg-red-50 border-red-200' : 'bg-gray-50 border-gray-200' %>">
      <div class="flex items-center gap-3">
        <div class="text-2xl <%= @unresolved_contacts > 0 ? 'text-red-500' : 'text-gray-400' %>">
          <i class="fa-solid fa-envelope-open-text"></i>
        </div>

        <div>
          <p class="text-sm font-semibold text-gray-700">未対応のお問い合わせ</p>
          <p class="text-2xl font-bold <%= @unresolved_contacts > 0 ? 'text-red-500' : 'text-gray-400' %>">
            <%= @unresolved_contacts %> 件
          </p>
        </div>
      </div>
    </div>

    <!-- 異常価格 -->
    <div class="
      rounded-2xl p-5 shadow-md border
      <%= @abnormal_prices_count > 0 ? 'bg-yellow-50 border-yellow-200' : 'bg-gray-50 border-gray-200' %>">
      <div class="flex items-center gap-3">
        <div class="text-2xl <%= @abnormal_prices_count > 0 ? 'text-yellow-500' : 'text-gray-400' %>">
          <i class="fa-solid fa-triangle-exclamation"></i>
        </div>

        <div>
          <p class="text-sm font-semibold text-gray-700">価格の異常値</p>
          <p class="text-2xl font-bold <%= @abnormal_prices_count > 0 ? 'text-yellow-600' : 'text-gray-400' %>">
            <%= @abnormal_prices_count %> 件
          </p>
        </div>
      </div>
    </div>
  </div>
</section>

<% if @abnormal_price_records.any? %>
  <div class="mt-6 bg-white rounded-2xl shadow-md border border-orange-100 p-5">
    <p class="text-base font-semibold text-gray-800 mb-4 flex items-center gap-2">
      <i class="fa-solid fa-chart-line text-orange-500"></i>
      最近の異常値（最大5件）
    </p>

    <ul class="space-y-4 text-sm text-gray-700">
      <% @abnormal_price_records.each do |item| %>
        <% pr = item[:record] %>
        <% avg = item[:avg_price] %>
        <% deviation = item[:deviation] %>

        <li class="
          p-4 rounded-xl border flex flex-col gap-2
          <%= deviation > 0 ? 'bg-red-50/70 border-red-200' : 'bg-blue-50/70 border-blue-200' %>
        ">
          <div class="flex justify-between items-start">
            <div class="font-medium">
              <span class="text-gray-800"><%= pr.product.name %></span>
              <span class="text-xs text-gray-500">
                （店：<%= pr.shop&.name || "不明" %> / 登録者：<%= pr.user&.nickname || "不明" %>）
              </span>
            </div>

            <span class="text-lg font-bold flex items-center gap-1
              <%= deviation > 0 ? 'text-red-500' : 'text-blue-500' %>">
              <% if deviation > 0 %>
                <i class="fa-solid fa-arrow-trend-up"></i>
                +<%= deviation %>%
              <% else %>
                <i class="fa-solid fa-arrow-trend-down"></i>
                -<%= deviation.abs %>%
              <% end %>
            </span>
          </div>

          <div class="flex justify-between text-xs text-gray-600 mt-1">
            <span>
              現在：<strong class="text-gray-800"><%= pr.price %>円</strong>
            </span>
            <span>平均：<%= avg %>円</span>
          </div>
        </li>
      <% end %>
    </ul>

    <% if @abnormal_prices_count > 5 %>
      <div class="mt-4 text-right">
        <%= link_to "すべての異常値を見る →", admin_abnormal_prices_path,
              class: "text-orange-600 text-sm font-semibold hover:underline" %>
      </div>
    <% end %>
  </div>
<% end %>

<section class="space-y-6 mt-10">
  <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
    <span class="inline-flex items-center justify-center w-8 h-8 rounded-xl bg-orange-100 text-orange-500">
      📈
    </span>
    統計ハイライト
  </h2>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

    <!-- 商品ランキング -->
    <div class="bg-white rounded-2xl shadow-md border border-orange-100 p-5">
      <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
        <i class="fa-solid fa-box text-orange-500"></i>
        登録が多い商品 TOP5
      </h3>
      <ul class="space-y-3">
        <% @top_products.each_with_index do |product, i| %>
          <li class="flex justify-between items-center p-3 rounded-xl border
            <%= i == 0 ? 'bg-orange-50 border-orange-200' : 'border-orange-100 bg-white' %>
            hover:bg-orange-50 transition">
            <div class="flex items-center gap-3">
              <span class="text-lg font-bold <%= i == 0 ? 'text-orange-600' : 'text-gray-500' %>">
                <%= i + 1 %>
              </span>
              <span class="text-gray-700 font-medium">
                <%= product.name %>
              </span>
            </div>
            <span class="text-gray-600 text-sm font-semibold">
              <%= product.records_count %> 件
            </span>
          </li>
        <% end %>
        <% if @top_products.empty? %>
          <p class="text-gray-400 text-sm">データがありません。</p>
        <% end %>
      </ul>
    </div>

    <!-- 店舗ランキング -->
    <div class="bg-white rounded-2xl shadow-md border border-orange-100 p-5">
      <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
        <i class="fa-solid fa-store text-orange-500"></i>
        登録が多い店舗 TOP5
      </h3>
      <ul class="space-y-3">
        <% @top_shops.each_with_index do |shop, i| %>
          <li class="flex justify-between items-center p-3 rounded-xl border
            <%= i == 0 ? 'bg-orange-50 border-orange-200' : 'border-orange-100 bg-white' %>
            hover:bg-orange-50 transition">
            <div class="flex items-center gap-3">
              <span class="text-lg font-bold <%= i == 0 ? 'text-orange-600' : 'text-gray-500' %>">
                <%= i + 1 %>
              </span>
              <span class="text-gray-700 font-medium">
                <%= shop.name %>
              </span>
            </div>
            <span class="text-gray-600 text-sm font-semibold">
              <%= shop.records_count %> 件
            </span>
          </li>
        <% end %>
        <% if @top_shops.empty? %>
          <p class="text-gray-400 text-sm">データがありません。</p>
        <% end %>
      </ul>
    </div>
  </div>
</section>
